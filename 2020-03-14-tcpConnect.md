---
title: 三次握手与四次挥手
date: 2020-03-14 13:44:04
categories: 
    - 计算机网络
tags: 
    - tcp
---

# TCP三次握手

当获取IP之后，客户端就会发送一个报文段给服务器，开启三次握手。

![baowenduan](baowenduan.png)

其中确认号下面那个犄角旮旯里：

>URG(urgent)：紧急，为1时表示有紧急数据，应正确传送。
>ACK(acknowledgement)：确认，为1时确认字号才有效，一旦TCP连接建立，就必须把ACK置为1。
>PSH(push)：传送，为1时表示尽快交付，不必把整个缓存都填满后再交付。
>RST(reset)：重置，为1时表示连接中出现严重差错，必须释放连接，重新建立。
>SYN(synchronous)：建立联机，为1时表示这是一个连接请求或连接接受报文。
>FIN(finish)：结束，为1时表示此报文段的发送端的数据已发送完毕，要求释放传输连接。
>
>Sequence number(seq)：顺序号码
>Acknowledge number(ack)：确认号码

![sanciwoshou](sanciwoshou.png)

[图片来源：B站-计算机网络第36讲](https://www.bilibili.com/video/av52745283?from=search&seid=12199868811481081570)

三次握手功能如下：

>客户端：服大大，我要发数据给你哇，你快来接收啦。
>服务器：好的，老客你发吧。
>客户端：嗯嗯，那我发了。

那为什么是三次握手呢？

这就要考虑到传输时丢包的问题，即当服务器发送给客户端的数据丢包了，如果只有两次握手，服务器是无法确认客户端是否能收到自己的回复。所以第三次握手的作用就是，如果服务器收不到客户端对自己的回复，那么它就会继续发送，直到确认客户端收到了自己的回复。

>客户端：服大大，我要发数据给你哇，你快来接收啦。
>客户端：（？？？没收到？再来一次）
>客户端：服大大，我要发数据给你哇，你快来接收啦。
>服务器：好的，老客你发吧。
>服务器：（？？？怎么不回我，可能又丢包了，那再发一次吧）
>服务器：好的，老客你发吧。
>客户端：嗯嗯，那我发了。
>服务器：（收到了老客的回复，说明我们的TCP连接已经建立）
>客户端：（不管服大大有没有收到这条消息，我都认为我们的TCP连接已经建立）

当然这也只是比较理想的一种情况，现实中这些传递的包可能会卡在路上过了很久之后才传过来，这个时候很有可能客户端与服务器都传输完数据了。如果只有两次握手的话，那么很有可能会再次唤起服务器，造成资源的浪费。  

![erciwoshou](erciwoshou.png)

[图片来源：B站-计算机网络第36讲](https://www.bilibili.com/video/av52745283?from=search&seid=12199868811481081570)

>客户端：服大大，我要发数据给你哇，你快来接收啦。（1）
>客户端：（？？？没收到？再来一次）
>客户端：服大大，我要发数据给你哇，你快来接收啦。（2）
>服务器：好的，老客你发吧。（2）
>客户端与服务器开心的发完数据，并且关闭了连接。
>服务器：你怎么又来了？（1）
>服务器建立连接（1）
>服务器等待客户端传输请求（1）
>服务器：我等（1）
>服务器：我等（1）
>服务器：我等等等（1）
>……
>服务器：？？……？？（1）
>服务器亡（1）

# 传输数据

握手成功后，开始传输数据，数据被分为多个分节，一次数据的传输需要2个TCP包。数据发送包，接收方应答包。

如果已经建立了连接，客户端突然出现故障。TCP设有一个保活计时器，服务器每收到一次客户端的请求后都会重新复位这个计时器，时间通常是设置为2小时，若两小时还没有收到客户端的任何数据，服务器就会发送一个探测报文段，以后每隔75秒发送一次。若一连发送10个探测报文仍然没反应，服务器就认为客户端出了故障，接着就关闭连接。

# TCP四次挥手  

![sicihuishou](sicihuishou.png)

[图片来源：B站-计算机网络第36讲](https://www.bilibili.com/video/av52745283?from=search&seid=12199868811481081570)

>客户端发完数据
>客户端：服大大，我数据发完了。(停止发送数据，进入终止等待1状态)
>服务器：好的，我知道了。(进入关闭等待状态)
>客户端收到回复进入终止等待2状态
>服务器发完数据
>服务器：老客啊，我也发完了。(进入最后确认状态)
>客户端接收完数据：好的。(客户端进入时间等待状态，服务器进入CLOSED状态)
>2*MSL(最长报文段寿命Maximum Segment Lifetime)时间后，客户端进入CLOSED状态。

客户端等待2MSL的原因：

第一，保证客户端发送的最后一个ACK报文能够到达服务器，因为这个ACK报文可能丢失，站在服务器的角度看来，我已经发送了FIN+ACK报文请求断开了，客户端还没有给我回应，应该是我发送的请求断开报文它没有收到，于是服务器又会重新发送一次，而客户端就能在这个2MSL时间段内收到这个重传的报文，接着给出回应报文，并且会重启2MSL计时器。

第二，防止类似与“三次握手”中提到了的“已经失效的连接请求报文段”出现在本连接中。客户端发送完最后一个确认报文后，在这个2MSL时间中，就可以使本连接持续的时间内所产生的所有报文段都从网络中消失。这样新的连接中不会出现旧连接的请求报文。

# 参考文献

[知乎-TCP 为什么是三次握手，而不是两次或四次？](https://www.zhihu.com/question/24853633)

[B站-计算机网络第36讲](https://www.bilibili.com/video/av52745283?from=search&seid=12199868811481081570)

[CSDN-小书go](https://blog.csdn.net/qzcsu/article/details/72861891)
---
title: 网络层相关知识点
date: 2020-03-15 14:59:33
categories: 
    - 计算机网络
tags: 
    - networkLayer
---

# 概述

- 主机对主机
- 单位：Packets包：数据报
- 硬件：路由器
- 任务：将传输层传下来的报文段封装成分组，选择适当的路由，是传输层传下来的分组能够交付到目的主机
- 功能
  - 为传输层提供服务
  - 组包和拆包
  - 路由选择：确定进来的分组应该被传送到哪一条路线上
  - 分组转发：将IP数据报从适合的端口转发出去
  - 拥塞控制：开环控制、闭环控制
  - 异构网络互连：各种网络协议不同，但是让用户看起来是一个整体
- 协议：ICMP、ARP、RARP、IP、IGMP

# IP

## IPv4

### 数据报

- 总长度：数据包的总长是MAC地址数据部分，1500B，如果超出则分片
- 标志：MF合并数据报、DF=1不可以分片，当数据报过大时，返回ICMP告知最大传输单位、DF=0可以分片传输

### 地址分类

| 类别     | 地址                      | 私有地址                    |
| -------- | ------------------------- | --------------------------- |
| 网络号   | 0.0.0.0                   | \                           |
| 广播地址 | 255.255.255.255           | \                           |
| A类      | 1.0.0.0~126.255.255.255   | 10.0.0.0~10.255.255.255     |
| B类      | 128.1.0.0~191.255.255.255 | 172.16.0.0~172.31.255.255   |
| C类      | 192.0.1.0~223.255.255.255 | 192.168.0.0~192.168.255.255 |

| 特殊地址             | 解释                                                         |
| -------------------- | ------------------------------------------------------------ |
| 网络地址             |                                                              |
| 直接广播地址         | 主机号全为1，该组所有主机都会收到，只能做目的地址            |
| 受限广播地址         | 全1，用于定义当前网络                                        |
| 这个网络上的这个主机 | 全0，主机为了发现自己的IP地址，使用全0作为源地址，全1作为目的地址 |
| 这个网络上的特定主机 | 用于某个主机向同一网络上的其他主机发送报文                   |
| 回环地址             | 127开头，用来测试机器的软件，客户机进程用回环地址给同样机器上的服务器进程发送请求 |

### NAT(内外网转换)

  - 节省IP地址
  - 隐藏内部真实IP
  - TCP负载均衡
  - 两网合并，解决内网地址冲突问题

### 子网掩码

子网划分
- 由两级变为三级
- IP地址：{<网络号>,<子网号>,<主机号>}

子网掩码

- 用子网掩码表示网络号长度

### CIDR无分类编址

IP地址：{<网络前缀>,<主机号>}，类似于子网掩码

### ARP

  - 解决同一局域网主机或路由器IP地址和硬件地址的映射问题
  - 每个主机中都有ARP高速缓存，用来存放所有局域网上的各主机和路由器的IP地址到硬件地址的映射表
  - ARP请求分组是广播发送的，响应分组是普通的单播
  - 四种情况
    - 发送方是主机or路由器，要把IP数据报发送到本网络上的主机，这时用ARP找到目的主机的硬件地址
    - 发送方是主机or路由器，要把IP数据报发送到另一个网络上的主机，这时用ARP找到本网络上的一个路由器的硬件地址，然后交给路由器

### DHCP动态主机配置协议

  - 动态分配IP地址
  - 允许一台计算机加入新的网络获取IP地址，不需要手工参与
  - 是应用层协议，使用UDP传输
  - 分配的IP地址是临时的，只能在一段时间内（租用期）使用

过程

- DHCP客户机广播“DHCP发现”消息，试图找到网络中的DHCP服务器，服务器获取一个IP地址
- DHCP服务器收到“DHCP发现”消息，就向网络提供“DHCP提供”消息，其中包括提供DHCP客户机的IP地址和相关配置信息
- DHCP客户机收到“DHCP提供”消息，如果接收DHCP提供的相关参数，则广播“DHCP请求”消息向DHCP服务器请求提供IP地址
- DHCP服务器广播“DHCP确认”消息，分配IP地址给DHCP客户机
- 当有多个客户机请求时，DHCP通常选择最先到达的信息

### ICMP

差错报告报文

| 差错报告报文 | 解释                                                         |
| ------------ | ------------------------------------------------------------ |
| 终点不可达   | 路由或主机不能交付数据时，使源点知道终点不可达               |
| 源站抑制     | 路由或主机由于拥塞而丢弃数据报时，向源点发送，使源点发送速率变慢 |
| 时间超时     | 当IP分组TTL值被减为0后，路由器除了要丢弃该分组还要向源点发送时间超时；当终点在预先规定的时间内不能收到一个数据报的全部数据报片时，向源点发送时间超时 |
| 参数问题     | 路由器或目的主机收到的数据报的首部中有字段的值不正确时，就丢弃该数据报，并向源点发送，现在一般不发 |
| 改变路由     | 重定向，路由器把改变路由报文发送给主机，让主机知道下次应将数据报发送给其他的路由器 |

询问报文
- 有回送请求和回答报文
- 时间戳请求和回答报文
- 掩码地址请求和回答报文
- 路由器询问和通告报文

不发送报告的几种情况
- 对ICMP差错报告报文不再发送ICMP差错报告报文
- 对第一分片的数据报片的所有后续数据报片都不发送ICMP差错报告报文
- 对具有组播地址的数据报片都不发送ICMP差错报告报文
- 对具有特殊地址的数据报片（127.0.0.0或0.0.0.0）不发送ICMP差错报告报文

## IPv6

特点

- 128位
- 十六进制表示，四个一位用冒号隔开，四个全0可写为一个0，连着几个冒号都是0，可不写，但要确定个数只能出现一次
- 划分层次多
- 首部格式灵活：减少为8个段，更快处理分组，改善吞吐率
- 改进的选项：以前必要的现在可选了，加快分组处理速度
- 允许协议继续扩充
- 支持即插即用
- 支持资源的预分配

三种地址类型：单播、组播、广播

# 路由协议

| 路由算法 | 解释     |
| -------- | -------- |
| 动态路由 | 自动学习 |
| 静态路由 | 手动配置 |

## 内部网关协议IGP

一个自治系统内部所使用的路由选择协议称为内部网关协议IGP，路由选择称为域内路由选择，具体协议有RIP、OSPF。

| 参数     | RIP                                                          | OSPF                                                         |
| -------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 算法     | 距离-向量路由算法                                            | 链路状态路由算法                                             |
| 协议参数 | 用于表示目的网络远近的参数为跳数，即到达目的网络所经过的路由器个数，最大为15 | 表示的目的网络的数为虚拟值，与链路的带宽相等，不受物理跳数的限制，适合大型网络 |
| 收敛速度 | 将整个路由表作为路由信息广播至网络中，周期为30s，占用资源，影响收敛 | 路由信息比较少，广播非周期性，收敛效果好                     |
| 分层     | 网络是平面概念，无区域或边界的定义                           | 网络或自治系统可以划分很多区域，每个区域通过OSPF边界路由相连 |
| 负载平衡 | 只安装一条路径传输数据                                       | 同一个目的网络有多条相同代价的路径，可以将通信量分配给这几条路径 |
| 灵活性   | 无                                                           | 对不同链路根据IP分组不同服务类型而设置不同代价               |
|          | 不以组播地址发送报文                                         | 以组播地址发送报文                                           |
|          | 采用跳数作为距离的代价                                       |                                                              |
|          |                                                              | 将一个自治系统再划分为若干更小的范围，成为区域。             |
|          | 是被动的，基于谣言的，靠邻居路由判断，仅和邻居交换信息       | 是独立决策的，会主动测试所有邻接节点的状态，定期的将链路状态传播给其他所有节点，说明本路由器和哪些路由器相邻以及该链路的度量 |
|          | 交换的信息是当前本路由器所知道的信息，即自己的路由表，并按照固定的时间交换路由信息 | 使用洪泛法，通过所有输出端口向所有邻接路由，发送的信息是本路由器相邻的所有路由的链路状态，但只是路由器所知道的部分信息。只有链路状态都发生变化时，路由器才用洪泛法向所有路由器发送信息 |

### RIP距离矢量选择协议

- 先修改此RIP报文中所有项目，把下一跳字段中的地址都改为X，并把所有距离字段+1

- 对修改后的RIP报文中的每一个项目执行如图操作

  ![图片-RIP执行过程](rip.jpg)

- 若3min还没收到相邻路由器的更新路由表则把相邻路由器记为不可达路由，记为16，若120s后仍未收到更新的报文，则删除


报文格式：首部、路由

优点：简单、开销小、收敛过程较快

缺点

- RIP限制了网络的规模，它能使用的最大距离为15
- 路由器之间交换的路由信息是路由器中的最完整路由表，随网络规模增加，开销也增加
- 当网络出现故障时，经过较长的时间才能将此信息传送到所有的路由器，即坏消息传播的慢，更新过程的收敛时间长

### OSPF链路状态协议

| 分组类型         | 描述                                                         |
| ---------------- | ------------------------------------------------------------ |
| 问候分组         | 发现和维持邻站的可达性                                       |
| 数据库描述分组   | 向邻站给出自己的链路状态数据库中的所有链路状态项目的摘要信息 |
| 链路状态请求分组 | 向对方请求某些链路的详细信息                                 |
| 链路状态更新分组 | 用洪泛法对全网更新链路状态                                   |
| 链路状态确认分组 | 对链路更新分组的确认                                         |

## 外部网关协议EGP

自治系统之间使用的路由选择协议成为外部网关协议EGP，路由选择成为域间路由选择

## 边界网关协议BGP

- 不同自治系统之间交换路由信息的协议
- 路径向量路由选择协议
- 寻找一条相对来说比较好的路由
- 特点
  - 交换路由信息的节点数量级是自治系统数的量级，比自治系统中的网络数少很多
  - 每一个自治系统中BGP发言人的数目很少，系统不过分复杂
  - 支持CIDR，其路由表包括目的网络前缀、下一跳路由器、到达该目的网络所要经过的各个自治系统序列
  - 再BGP刚运行时，BGP的邻站是交换整个的BGP路由表，但以后只需在变化部分更新

| 报文     | 描述                                         |
| -------- | -------------------------------------------- |
| 打开报文 | 用来与相邻的另一个BGP发言人建立关系          |
| 更新报文 | 用来发送某一路由信息以及列出要撤销的多条路由 |
| 保活报文 | 用来确认打开报文和周期性的证实邻站关系       |
| 通知报文 | 用来发送检测到的差错                         |

![图片-路由协议](xieyi.jpg)

# IP组播

需要支持组播协议的路由器，使用D类地址224.0.0.0~239.255.255.255,前缀1110，只能用于目的地址，尽最大努力交付，不提供可靠传输，不产生ICMP，并非所有D类地址都可以组播。

## 分类

- 只在本局域网上进行硬件组播
- 在因特网的范围内进行组播

## 组播地址换算MAC

- IP地址化为二进制，取最后23位
- 第24位为0
- 四位一组换为十六进制
- 在前面加上固定首部01-00-5E

# 移动IP

实现权限漫游的功能

| 功能实体 | 描述                                                         |
| -------- | ------------------------------------------------------------ |
| 移动节点 | 具有永久IP地址的移动节点                                     |
| 本地代理 | 有一个端口与移动节点本地链路相连的路由器，根据移动用户的转交地址，采用隧道技术转交移动节点的数据报 |
| 外部代理 | 移动节点的漫游链路上的路由节点，他通知本地用户代理自己的转交地址，是移动节点漫游链路的默认路由器 |

| 四大技术     | 描述                                               |
| ------------ | -------------------------------------------------- |
| 代理搜索     | 知道自己是否正在漫游                               |
| 申请转交地址 | 移动节点到外网时从外代理处得到的临时地址           |
| 登录         | 移动节点到达外网的一系列认证、注册、建立隧道的过程 |
| 隧道         | 本地代理与外部代理之间建立的双向数据通道           |

过程

- 移动节点在本地网时，按传统的TCP/IP进行通信
- 移动节点漫游到一个外地网络时，仍按使用固定的IP地址进行通信，为了能够收到通信对端发给它的IP分组，移动节点需要向本地代理注册当前的位置地址，这个位置地址就是转交地址，移动IP的转交地址可以是外部代理的地址或动态配置的一个地址
- 本地代理收到来自转交地址的注册后，就会构建一条通向转交地址的隧道，将截获的发给移动节点的IP分组通过隧道传送到转交地址处
- 在转交地址处解除隧道封装，恢复出原始的IP分组，最后送到移动节点，这样移动节点在外网就能够收到这些送给它的IP分组了
- 移动节点在外网通过外网的路由器或者外代理向通信对端发送IP数据报
- 当移动节点来到另一个网络时，只需要向本地代理更新注册的转交地址，就可以继续通信了
- 当移动节点回到本地网时，移动节点想本地代理注销转交地址，这时移动节点又将使用传统的TCP/IP方式进行通信

# 网络层设备，路由器

路由选择部分：
- 核心部件：路由选择处理器
- 根据所选定的路由选择协议构造出路由表，同时经常或定期的和相邻路由器交换路由信息不断更新和维护路由表

分组转发部分
- 组成：一组输入端口、交换结构、一组输出端口
- 交换方法：通过存储器进行交换、通过总线进行交换、通过互联网络进行交换

- 过程：从输入端口进。查找转发表，或排队等待。进入交换接口。进行缓存，并在数据链路层处理模块中给分组加上数据链路层的首部尾部。交给物理层发送到外部线路。

# 参考文献

天勤计算机网络